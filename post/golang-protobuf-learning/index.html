<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Golang protobuf快速上手 | Betterman</title>
<meta name="description" content="我的小屋
在星星下面 在城市的楼群之间">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://meetbetter.github.io/favicon.ico?v=1563680002907">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://meetbetter.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143873677-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-143873677-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://meetbetter.github.io">
        <img src="https://meetbetter.github.io/images/avatar.png?v=1563680002907" class="site-logo">
        <h1 class="site-title">Betterman</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/meetbetter" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      我的小屋
在星星下面 在城市的楼群之间
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://meetbetter.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Golang protobuf快速上手</h2>
            <div class="post-date">2019-03-20</div>
            
            <div class="post-content">
              <h1 id="说明">说明</h1>
<p><a href="https://github.com/meetbetter/protocol-buffer-demo">Demo源码</a></p>
<p>protocol buffer是谷歌推出的高效率序列化反序列化工具，可以自定义数据结构，然后使用对应语言的代码生成器生成的代码读写这个数据结构。虽然在和前端打交道时还是要配合使用JSON，但是在其他场合可以尝试使用protocol buffer改进性能。</p>
<p>下面总结下在GoLang中使用protocol buffer的方法。</p>
<h1 id="go环境配置">Go环境配置</h1>
<h2 id="下载protobuf">下载protobuf</h2>
<pre><code class="language-shell">git clone https://github.com/protocolbuffers/protobuf.git
</code></pre>
<h2 id="安装linux-ubuntu">安装(Linux Ubuntu)</h2>
<h3 id="1安装依赖工具">(1)安装依赖工具</h3>
<pre><code class="language-shell">sudo apt-get install autoconf automake libtool curl make g++ unzip libffi-dev -y
</code></pre>
<h3 id="2进入protobuf文件">(2)进入protobuf文件</h3>
<pre><code class="language-shell">cd protobuf/
</code></pre>
<h3 id="3进行安装检测-并生成自动安装脚本">(3)进行安装检测 并生成自动安装脚本</h3>
<pre><code class="language-shell">./autogen.sh
./configure
</code></pre>
<h3 id="4进行编译c代码和安装">(4)进行编译C代码和安装</h3>
<pre><code class="language-shell">make
sudo make install
</code></pre>
<h3 id="5刷新linux共享库关系">(5)刷新linux共享库关系</h3>
<pre><code class="language-shell">sudo ldconfig
</code></pre>
<h3 id="6测试protobuf编译工具">(6)测试protobuf编译工具</h3>
<pre><code class="language-shell">protoc -h
</code></pre>
<p>如果正常输出 相关指令 没有报任何error，为安装成功。</p>
<h2 id="获取-golang的proto包">获取 GoLang的proto包</h2>
<h3 id="1下载">(1)下载</h3>
<pre><code class="language-shell">go get -v -u github.com/golang/protobuf/proto
</code></pre>
<h3 id="2进入到文件夹内进行编译">(2)进入到文件夹内进行编译</h3>
<pre><code class="language-shell">cd $GOPATH/src/github.com/golang/protobuf/protoc-gen-go/
go build
</code></pre>
<h3 id="3拷贝可执行文件">(3)拷贝可执行文件</h3>
<p>将生成的 protoc-gen-go可执行文件，放在/bin目录下。</p>
<pre><code class="language-shell">sudo cp protoc-gen-go /bin/
</code></pre>
<p>尝试补齐protoc-gen-go 如果可以补齐代表成功，如果执行不报错 代表工具成功。</p>
<h1 id="go使用protobuf">Go使用protobuf</h1>
<h2 id="新建proto文件">新建.proto文件</h2>
<p>基本格式如下：</p>
<pre><code class="language-protobuf">syntax = &quot;proto3&quot;; //必须指定protobuf协议版本号
package pb; //包名

//定义一个protobuf协议
message Person {
    string name = 1; //数字表示序号，并不是变量值.
    int32 age = 2;
    repeated string hobby = 3; //对应go中[]string

}
</code></pre>
<h2 id="生成go数据结构">生成Go数据结构</h2>
<p>在.proto所在目录执行如下命令，</p>
<pre><code class="language-shell">protoc --go_out=.  *.proto
</code></pre>
<p>在当前目录下会生成对应的.go文件，可以在其中找到go的数据结构，</p>
<pre><code class="language-go">type Person struct {
	Name                 string   `protobuf:&quot;bytes,1,opt,name=name,proto3&quot; json:&quot;name,omitempty&quot;`
	Age                  int32    `protobuf:&quot;varint,2,opt,name=age,proto3&quot; json:&quot;age,omitempty&quot;`
	Hobby                []string `protobuf:&quot;bytes,3,rep,name=hobby,proto3&quot; json:&quot;hobby,omitempty&quot;`
	XXX_NoUnkeyedLiteral struct{} `json:&quot;-&quot;`
	XXX_unrecognized     []byte   `json:&quot;-&quot;`
	XXX_sizecache        int32    `json:&quot;-&quot;`
}
</code></pre>
<p><strong>注意</strong>，该文件只能生成不能手动修改。</p>
<h2 id="使用protobuf">使用protobuf</h2>
<p>在main函数中新建Person对象并进行序列化和反序列化，</p>
<pre><code class="language-go">package main

import (
	&quot;protobufDemo/pb&quot;
	&quot;github.com/golang/protobuf/proto&quot;
	&quot;fmt&quot;
)

func main() {

	//序列化
	person := &amp;pb.Person{
		Name:&quot;Jack&quot;,
		Age:18,
		Hobby:[]string{&quot;sing&quot;,&quot;dance&quot;,&quot;basketball&quot;,&quot;rap&quot;},
	}

	binaryData, err := proto.Marshal(person)
	if err != nil {
		fmt.Println(&quot;proto.Marshal err:&quot;,err)
	}

	//反序列化
	newPerson := &amp;pb.Person{}
	err = proto.Unmarshal(binaryData,newPerson)
	if err != nil {
		fmt.Println(&quot;proto.Unmarshal err:&quot;,err)
	}

	fmt.Println(&quot;序列化前的原始数据:&quot;,person)
	fmt.Println(&quot;反序列化得到数据:&quot;,newPerson)
}

</code></pre>
<p>执行后可以看到person和newPerson都喜欢<strong>唱、跳、篮球和rap</strong>。</p>
<pre><code class="language-shell">序列化前的原始数据: name:&quot;Jack&quot; age:18 hobby:&quot;sing&quot; hobby:&quot;dance&quot; hobby:&quot;basketball&quot; hobby:&quot;rap&quot; 
反序列化得到数据: name:&quot;Jack&quot; age:18 hobby:&quot;sing&quot; hobby:&quot;dance&quot; hobby:&quot;basketball&quot; hobby:&quot;rap&quot;
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://meetbetter.github.io/tag/CkXDaoDR0" class="tag">
                    Golang
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://meetbetter.github.io/post/go-rpc-learning-1">
                  <h3 class="post-title">
                    Go RPC对比和示例
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '7c65ded90d138e1d98b6',
        clientSecret: '82107256fb2d1c871aa25c57faf4a523d8da5a54',
        repo: 'meetbetter.github.io',
        owner: 'meetbetter',
        admin: ['meetbetter'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
